---

# CORE #

- name: pull newslynx-core
  command: "git pull origin {{app_branch}}"
  args:
    chdir: "{{home}}/newslynx-app/"
  sudo: yes
  ignore_errors: yes

- name: update configurations template
  template: 
  args:
    src: "templates/.newslynx/config.yaml.j2"
    dest: "~/.newslynx/config.yaml"
    mode: 0700
  sudo: yes

- name: update newslynx-core
  command: make app_install 
  args:
    chdir: "{{home}}/newslynx-core/"

# APP #

- name: pull newslynx-app
  command: "git pull origin {{app_branch}}"
  args:
    chdir: "{{home}}/newslynx-app/"
  sudo: yes
  ignore_errors: yes

- name: update newslynx-app dependencies
  command: sudo npm install 
  args:
    chdir: "{{home}}/newslynx-app"
  sudo: yes

- name: restart app 
  command: "npm run forever-restart"
  args:
    chdir: "{{home}}/newslynx-app"
  sudo: yes


# RESTART #

- name: restart services
  service: name=postgresql state=restarted
  with_items:
    - redis 
    - postgresql 
    - supervisor 
    - nginx
